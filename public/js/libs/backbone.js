// Backbone.js 0.9.2 - unreleased master downloaded 10/6/2012 to fix model save

// (c) 2010-2012 Jeremy Ashkenas, DocumentCloud Inc.
// Backbone may be freely distributed under the MIT license.
// For all details and documentation:
// http://backbonejs.org
(function(){var j=this,x=j.Backbone,h=Array.prototype,y=h.push,z=h.slice,A=h.splice,g;g="undefined"!==typeof exports?exports:j.Backbone={};g.VERSION="0.9.2";var e=j._;!e&&"undefined"!==typeof require&&(e=require("underscore"));g.$=j.jQuery||j.Zepto||j.ender;g.noConflict=function(){j.Backbone=x;return this};g.emulateHTTP=!1;g.emulateJSON=!1;var p=/\s+/,h=g.Events={on:function(a,b,d){var c,f;if(!b)return this;a=a.split(p);for(c=this._callbacks||(this._callbacks={});f=a.shift();)f=c[f]||(c[f]=[]),f.push(b,
d);return this},off:function(a,b,d){var c,f,l;if(!(f=this._callbacks))return this;if(!a&&!b&&!d)return delete this._callbacks,this;for(a=a?a.split(p):e.keys(f);c=a.shift();)if(!(l=f[c])||!b&&!d)delete f[c];else for(c=l.length-2;0<=c;c-=2)b&&l[c]!==b||d&&l[c+1]!==d||l.splice(c,2);return this},trigger:function(a){var b,d,c,f,e,g,i;if(!(d=this._callbacks))return this;i=[];a=a.split(p);f=1;for(e=arguments.length;f<e;f++)i[f-1]=arguments[f];for(;b=a.shift();){if(g=d.all)g=g.slice();if(c=d[b])c=c.slice();
if(c){f=0;for(e=c.length;f<e;f+=2)c[f].apply(c[f+1]||this,i)}if(g){b=[b].concat(i);f=0;for(e=g.length;f<e;f+=2)g[f].apply(g[f+1]||this,b)}}return this}};h.bind=h.on;h.unbind=h.off;var m=g.Model=function(a,b){var d,c=a||{};b&&b.collection&&(this.collection=b.collection);b&&b.parse&&(a=this.parse(a));if(d=e.result(this,"defaults"))c=e.extend({},d,c);this.attributes={};this._escapedAttributes={};this.cid=e.uniqueId("c");this.changed={};this._changes={};this._pending={};this.set(c,{silent:!0});this.changed=
{};this._changes={};this._pending={};this._previousAttributes=e.clone(this.attributes);this.initialize.apply(this,arguments)};e.extend(m.prototype,h,{changed:null,_changes:null,_pending:null,_changing:null,idAttribute:"id",initialize:function(){},toJSON:function(){return e.clone(this.attributes)},sync:function(){return g.sync.apply(this,arguments)},get:function(a){return this.attributes[a]},escape:function(a){var b;if(b=this._escapedAttributes[a])return b;b=this.get(a);return this._escapedAttributes[a]=
e.escape(null==b?"":""+b)},has:function(a){return null!=this.get(a)},set:function(a,b,d){var c;if(null==a)return this;e.isObject(a)||((a={})[a]=b,b=d);var f=b&&b.silent,g=b&&b.unset;a instanceof m&&(a=a.attributes);if(g)for(c in a)a[c]=void 0;if(!this._validate(a,b))return!1;this.idAttribute in a&&(this.id=a[this.idAttribute]);var q=this._changing,i=this.attributes,h=this._escapedAttributes,r=this._previousAttributes||{};for(c in a){d=a[c];if(!e.isEqual(i[c],d)||g&&e.has(i,c))delete h[c],this._changes[c]=
!0;g?delete i[c]:i[c]=d;!e.isEqual(r[c],d)||e.has(i,c)!==e.has(r,c)?(this.changed[c]=d,f||(this._pending[c]=!0)):(delete this.changed[c],delete this._pending[c],q||delete this._changes[c]);q&&e.isEqual(i[c],q[c])&&delete this._changes[c]}f||this.change(b);return this},unset:function(a,b){b=e.extend({},b,{unset:!0});return this.set(a,null,b)},clear:function(a){a=e.extend({},a,{unset:!0});return this.set(e.clone(this.attributes),a)},fetch:function(a){var a=a?e.clone(a):{},b=this,d=a.success;a.success=
function(c,e,g){if(!b.set(b.parse(c,g),a))return!1;d&&d(b,c,a)};return this.sync("read",this,a)},save:function(a,b,d){var c,f;null!=a&&!e.isObject(a)&&((a={})[a]=b,b=d);b=b?e.clone(b):{};if(b.wait){if(!this._validate(a,b))return!1;c=e.clone(this.attributes)}d=e.extend({},b,{silent:!0});if(a&&!this.set(a,b.wait?d:b)||!a&&!this._validate(null,b))return!1;var g=this,h=b.success;b.success=function(d,c,i){f=!0;c=g.parse(d,i);b.wait&&(c=e.extend(a||{},c));if(!g.set(c,b))return!1;h&&h(g,d,b)};var i=this.sync(this.isNew()?
"create":"update",this,b);!f&&b.wait&&(this.clear(d),this.set(c,d));return i},destroy:function(a){var a=a?e.clone(a):{},b=this,d=a.success,c=function(){b.trigger("destroy",b,b.collection,a)};a.success=function(e){(a.wait||b.isNew())&&c();d&&d(b,e,a)};if(this.isNew())return a.success(),!1;var f=this.sync("delete",this,a);a.wait||c();return f},url:function(){var a=e.result(this,"urlRoot")||e.result(this.collection,"url")||s();return this.isNew()?a:a+("/"===a.charAt(a.length-1)?"":"/")+encodeURIComponent(this.id)},
parse:function(a){return a},clone:function(){return new this.constructor(this.attributes)},isNew:function(){return null==this.id},change:function(a){var b=this._changing,d=this._changing={},c;for(c in this._changes)this._pending[c]=!0;var f=this._changes;this._changes={};var g=[];for(c in f)d[c]=this.get(c),g.push(c);for(var f=0,h=g.length;f<h;f++)this.trigger("change:"+g[f],this,d[g[f]],a);if(b)return this;for(;!e.isEmpty(this._pending);){this._pending={};this.trigger("change",this,a);for(c in this.changed)!this._pending[c]&&
!this._changes[c]&&delete this.changed[c];this._previousAttributes=e.clone(this.attributes)}this._changing=null;return this},hasChanged:function(a){return null==a?!e.isEmpty(this.changed):e.has(this.changed,a)},changedAttributes:function(a){if(!a)return this.hasChanged()?e.clone(this.changed):!1;var b,d=!1,c=this._previousAttributes,f;for(f in a)if(!e.isEqual(c[f],b=a[f]))(d||(d={}))[f]=b;return d},previous:function(a){return null==a||!this._previousAttributes?null:this._previousAttributes[a]},previousAttributes:function(){return e.clone(this._previousAttributes)},
isValid:function(a){return!this.validate||!this.validate(this.attributes,a)},_validate:function(a,b){if(b&&b.silent||!this.validate)return!0;var a=e.extend({},this.attributes,a),d=this.validate(a,b);if(!d)return!0;b&&b.error&&b.error(this,d,b);this.trigger("error",this,d,b);return!1}});var n=g.Collection=function(a,b){b||(b={});b.model&&(this.model=b.model);void 0!==b.comparator&&(this.comparator=b.comparator);this._reset();this.initialize.apply(this,arguments);a&&(b.parse&&(a=this.parse(a)),this.reset(a,
{silent:!0,parse:b.parse}))};e.extend(n.prototype,h,{model:m,initialize:function(){},toJSON:function(a){return this.map(function(b){return b.toJSON(a)})},sync:function(){return g.sync.apply(this,arguments)},add:function(a,b){var d,c,f,g=b&&b.at,a=e.isArray(a)?a.slice():[a];d=0;for(c=a.length;d<c;d++)if(!(a[d]=this._prepareModel(a[d],b)))throw Error("Can't add an invalid model to a collection");for(d=a.length-1;0<=d;d--)c=a[d],(f=null!=c.id&&this._byId[c.id])||this._byCid[c.cid]?(b&&(b.merge&&f)&&
f.set(c,b),a.splice(d,1)):(c.on("all",this._onModelEvent,this),this._byCid[c.cid]=c,null!=c.id&&(this._byId[c.id]=c));this.length+=a.length;d=[null!=g?g:this.models.length,0];y.apply(d,a);A.apply(this.models,d);this.comparator&&null==g&&this.sort({silent:!0});if(b&&b.silent)return this;for(;c=a.shift();)c.trigger("add",c,this,b);return this},remove:function(a,b){var d,c,f,g;b||(b={});a=e.isArray(a)?a.slice():[a];d=0;for(c=a.length;d<c;d++)if(g=this.getByCid(a[d])||this.get(a[d]))delete this._byId[g.id],
delete this._byCid[g.cid],f=this.indexOf(g),this.models.splice(f,1),this.length--,b.silent||(b.index=f,g.trigger("remove",g,this,b)),this._removeReference(g);return this},push:function(a,b){a=this._prepareModel(a,b);this.add(a,b);return a},pop:function(a){var b=this.at(this.length-1);this.remove(b,a);return b},unshift:function(a,b){a=this._prepareModel(a,b);this.add(a,e.extend({at:0},b));return a},shift:function(a){var b=this.at(0);this.remove(b,a);return b},slice:function(a,b){return this.models.slice(a,
b)},get:function(a){return null==a?void 0:this._byId[null!=a.id?a.id:a]},getByCid:function(a){return a&&this._byCid[a.cid||a]},at:function(a){return this.models[a]},where:function(a){return e.isEmpty(a)?[]:this.filter(function(b){for(var d in a)if(a[d]!==b.get(d))return!1;return!0})},sort:function(a){if(!this.comparator)throw Error("Cannot sort a set without a comparator");e.isString(this.comparator)||1===this.comparator.length?this.models=this.sortBy(this.comparator,this):this.models.sort(e.bind(this.comparator,
this));(!a||!a.silent)&&this.trigger("reset",this,a);return this},pluck:function(a){return e.invoke(this.models,"get",a)},reset:function(a,b){for(var d=0,c=this.models.length;d<c;d++)this._removeReference(this.models[d]);this._reset();a&&this.add(a,e.extend({silent:!0},b));(!b||!b.silent)&&this.trigger("reset",this,b);return this},fetch:function(a){a=a?e.clone(a):{};void 0===a.parse&&(a.parse=!0);var b=this,d=a.success;a.success=function(c,e,g){b[a.add?"add":"reset"](b.parse(c,g),a);d&&d(b,c,a)};
return this.sync("read",this,a)},create:function(a,b){var d=this,b=b?e.clone(b):{},a=this._prepareModel(a,b);if(!a)return!1;b.wait||d.add(a,b);var c=b.success;b.success=function(a,b,e){e.wait&&d.add(a,e);c&&c(a,b,e)};a.save(null,b);return a},parse:function(a){return a},clone:function(){return new this.constructor(this.models)},chain:function(){return e(this.models).chain()},_reset:function(){this.length=0;this.models=[];this._byId={};this._byCid={}},_prepareModel:function(a,b){if(a instanceof m)return a.collection||
(a.collection=this),a;b||(b={});b.collection=this;var d=new this.model(a,b);return!d._validate(d.attributes,b)?!1:d},_removeReference:function(a){this===a.collection&&delete a.collection;a.off("all",this._onModelEvent,this)},_onModelEvent:function(a,b,d,c){("add"===a||"remove"===a)&&d!==this||("destroy"===a&&this.remove(b,c),b&&a==="change:"+b.idAttribute&&(delete this._byId[b.previous(b.idAttribute)],null!=b.id&&(this._byId[b.id]=b)),this.trigger.apply(this,arguments))}});e.each("forEach each map collect reduce foldl inject reduceRight foldr find detect filter select reject every all some any include contains invoke max min sortedIndex toArray size first head take initial rest tail last without indexOf shuffle lastIndexOf isEmpty".split(" "),
function(a){n.prototype[a]=function(){var b=z.call(arguments);b.unshift(this.models);return e[a].apply(e,b)}});e.each(["groupBy","countBy","sortBy"],function(a){n.prototype[a]=function(b,d){var c=e.isFunction(b)?b:function(a){return a.get(b)};return e[a](this.models,c,d)}});var t=g.Router=function(a){a||(a={});a.routes&&(this.routes=a.routes);this._bindRoutes();this.initialize.apply(this,arguments)},B=/\((.*?)\)/g,C=/:\w+/g,D=/\*\w+/g,E=/[-{}[\]+?.,\\^$|#\s]/g;e.extend(t.prototype,h,{initialize:function(){},
route:function(a,b,d){e.isRegExp(a)||(a=this._routeToRegExp(a));d||(d=this[b]);g.history.route(a,e.bind(function(c){c=this._extractParameters(a,c);d&&d.apply(this,c);this.trigger.apply(this,["route:"+b].concat(c));g.history.trigger("route",this,b,c)},this));return this},navigate:function(a,b){g.history.navigate(a,b);return this},_bindRoutes:function(){if(this.routes){var a=[],b;for(b in this.routes)a.unshift([b,this.routes[b]]);b=0;for(var d=a.length;b<d;b++)this.route(a[b][0],a[b][1],this[a[b][1]])}},
_routeToRegExp:function(a){a=a.replace(E,"\\$&").replace(B,"(?:$1)?").replace(C,"([^/]+)").replace(D,"(.*?)");return RegExp("^"+a+"$")},_extractParameters:function(a,b){return a.exec(b).slice(1)}});var k=g.History=function(){this.handlers=[];e.bindAll(this,"checkUrl");"undefined"!==typeof window&&(this.location=window.location,this.history=window.history)},u=/^[#\/]/,F=/^\/+|\/+$/g,G=/msie [\w.]+/,H=/\/$/;k.started=!1;e.extend(k.prototype,h,{interval:50,getHash:function(a){return(a=(a||this).location.href.match(/#(.*)$/))?
a[1]:""},getFragment:function(a,b){if(null==a)if(this._hasPushState||!this._wantsHashChange||b){var a=this.location.pathname,d=this.root.replace(H,"");a.indexOf(d)||(a=a.substr(d.length))}else a=this.getHash();return decodeURIComponent(a.replace(u,""))},start:function(a){if(k.started)throw Error("Backbone.history has already been started");k.started=!0;this.options=e.extend({},{root:"/"},this.options,a);this.root=this.options.root;this._wantsHashChange=!1!==this.options.hashChange;this._wantsPushState=
!!this.options.pushState;this._hasPushState=!(!this.options.pushState||!this.history||!this.history.pushState);var a=this.getFragment(),b=document.documentMode,b=G.exec(navigator.userAgent.toLowerCase())&&(!b||7>=b);this.root=("/"+this.root+"/").replace(F,"/");b&&this._wantsHashChange&&(this.iframe=g.$('<iframe src="javascript:0" tabindex="-1" />').hide().appendTo("body")[0].contentWindow,this.navigate(a));this._hasPushState?g.$(window).bind("popstate",this.checkUrl):this._wantsHashChange&&"onhashchange"in
window&&!b?g.$(window).bind("hashchange",this.checkUrl):this._wantsHashChange&&(this._checkUrlInterval=setInterval(this.checkUrl,this.interval));this.fragment=a;a=this.location;b=a.pathname.replace(/[^\/]$/,"$&/")===this.root;if(this._wantsHashChange&&this._wantsPushState&&!this._hasPushState&&!b)return this.fragment=this.getFragment(null,!0),this.location.replace(this.root+this.location.search+"#"+this.fragment),!0;this._wantsPushState&&(this._hasPushState&&b&&a.hash)&&(this.fragment=this.getHash().replace(u,
""),this.history.replaceState({},document.title,this.root+this.fragment+a.search));if(!this.options.silent)return this.loadUrl()},stop:function(){g.$(window).unbind("popstate",this.checkUrl).unbind("hashchange",this.checkUrl);clearInterval(this._checkUrlInterval);k.started=!1},route:function(a,b){this.handlers.unshift({route:a,callback:b})},checkUrl:function(){var a=this.getFragment();a===this.fragment&&this.iframe&&(a=this.getFragment(this.getHash(this.iframe)));if(a===this.fragment)return!1;this.iframe&&
this.navigate(a);this.loadUrl()||this.loadUrl(this.getHash())},loadUrl:function(a){var b=this.fragment=this.getFragment(a);return e.any(this.handlers,function(a){if(a.route.test(b))return a.callback(b),!0})},navigate:function(a,b){if(!k.started)return!1;if(!b||!0===b)b={trigger:b};a=this.getFragment(a||"");if(this.fragment!==a){this.fragment=a;var d=this.root+a;if(this._hasPushState)this.history[b.replace?"replaceState":"pushState"]({},document.title,d);else if(this._wantsHashChange)this._updateHash(this.location,
a,b.replace),this.iframe&&a!==this.getFragment(this.getHash(this.iframe))&&(b.replace||this.iframe.document.open().close(),this._updateHash(this.iframe.location,a,b.replace));else return this.location.assign(d);b.trigger&&this.loadUrl(a)}},_updateHash:function(a,b,d){d?(d=a.href.replace(/(javascript:|#).*$/,""),a.replace(d+"#"+b)):a.hash="#"+b}});g.history=new k;var v=g.View=function(a){this.cid=e.uniqueId("view");this._configure(a||{});this._ensureElement();this.initialize.apply(this,arguments);
this.delegateEvents()},I=/^(\S+)\s*(.*)$/,w="model collection el id attributes className tagName".split(" ");e.extend(v.prototype,h,{tagName:"div",$:function(a){return this.$el.find(a)},initialize:function(){},render:function(){return this},dispose:function(){this.undelegateEvents();this.model&&this.model.off&&this.model.off(null,null,this);this.collection&&this.collection.off&&this.collection.off(null,null,this);return this},remove:function(){this.dispose();this.$el.remove();return this},make:function(a,
b,d){a=document.createElement(a);b&&g.$(a).attr(b);null!=d&&g.$(a).html(d);return a},setElement:function(a,b){this.$el&&this.undelegateEvents();this.$el=a instanceof g.$?a:g.$(a);this.el=this.$el[0];!1!==b&&this.delegateEvents();return this},delegateEvents:function(a){if(a||(a=e.result(this,"events"))){this.undelegateEvents();for(var b in a){var d=a[b];e.isFunction(d)||(d=this[a[b]]);if(!d)throw Error('Method "'+a[b]+'" does not exist');var c=b.match(I),f=c[1],c=c[2],d=e.bind(d,this),f=f+(".delegateEvents"+
this.cid);""===c?this.$el.bind(f,d):this.$el.delegate(c,f,d)}}},undelegateEvents:function(){this.$el.unbind(".delegateEvents"+this.cid)},_configure:function(a){this.options&&(a=e.extend({},this.options,a));for(var b=0,d=w.length;b<d;b++){var c=w[b];a[c]&&(this[c]=a[c])}this.options=a},_ensureElement:function(){if(this.el)this.setElement(e.result(this,"el"),!1);else{var a=e.extend({},e.result(this,"attributes"));this.id&&(a.id=e.result(this,"id"));this.className&&(a["class"]=e.result(this,"className"));
this.setElement(this.make(e.result(this,"tagName"),a),!1)}}});var J={create:"POST",update:"PUT","delete":"DELETE",read:"GET"};g.sync=function(a,b,d){var c=J[a];d||(d={});var f={type:c,dataType:"json"};d.url||(f.url=e.result(b,"url")||s());if(!d.data&&b&&("create"===a||"update"===a))f.contentType="application/json",f.data=JSON.stringify(b);g.emulateJSON&&(f.contentType="application/x-www-form-urlencoded",f.data=f.data?{model:f.data}:{});if(g.emulateHTTP&&("PUT"===c||"DELETE"===c))g.emulateJSON&&(f.data._method=
c),f.type="POST",f.beforeSend=function(a){a.setRequestHeader("X-HTTP-Method-Override",c)};"GET"!==f.type&&!g.emulateJSON&&(f.processData=!1);var h=d.success;d.success=function(a,c,e){h&&h(a,c,e);b.trigger("sync",b,a,d)};var j=d.error;d.error=function(a){j&&j(b,a,d);b.trigger("error",b,a,d)};return g.ajax(e.extend(f,d))};g.ajax=function(){return g.$.ajax.apply(g.$,arguments)};m.extend=n.extend=t.extend=v.extend=function(a,b){var d=this,c;c=a&&e.has(a,"constructor")?a.constructor:function(){d.apply(this,
arguments)};e.extend(c,d,b);var f=function(){this.constructor=c};f.prototype=d.prototype;c.prototype=new f;a&&e.extend(c.prototype,a);c.__super__=d.prototype;return c};var s=function(){throw Error('A "url" property or function must be specified');}}).call(this);
